<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Proceed to recording</title>
    <link rel="stylesheet" href="{{ url_for('static',filename='css/css.css') }}">
    <script src="{{ url_for('static',filename='js/js.js') }}"></script>

    <!-- minimal CSS -->
    <style>
        body {
            max-width: 600px;
        }
        form {
            display: none;
        }
        label {
            display: block; margin-top: 12px;
        }
        input, select, button {
            width: 100%; 
        }
        button {
            margin-top: 2lvh;
        }
        input[type=text]:hover, input[type=text]:focus, input[type=number]:hover, input[type=number]:focus, button:hover {
            width: 100%;
        }
        .msg {
            margin-bottom: 16px;
            color: #b91c1c;
        }
        select {
            color: black;
        }
        option {
            color: black;
        }
    </style>
</head>
<body>
        <header class="heading">
    <h1 style="color:black;">Proceed to recording</h1>
    <a href="/" class="heading1"><h4>Home</h4></a>
    <a href="/my_sites" class="heading1"><h4>My sites</h4></a>
    <a href="/join_site" class="heading1"><h4>Join a site</h4></a>
    <a href="/create_site" class="heading1"><h4>Create a site</h4></a>
    <a href="/sites" class="heading1"><h4>Browse sites</h4></a>
    <a href="/log_artefact" class="heading1"><h4>Proceed to recording</h4></a>
    <div class="hovering">
        <h4 class="hovering-text">Profile</h4>
        <div class="hovering-content">
            <a href="/logout" class="heading3"><h6 class="heading3">Logout</h6></a>
            <a href="/profile" class="heading3"><h6 class="heading3">about</h6></a>
        </div>
    </div>
    </header>


<div class="everything-but-header">
<!-- flashed messages -->
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="msg">
      {% for message in messages %}
        <div>{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}


{% if no_sites %}
    <p>You donâ€™t belong to any sites.</p>
{% else %}





<form method="POST" id="artefactForm">
    <label>
        Artefact name
        <input type="text" name="name" required>
    </label>

    <label>
        Weight (kg)
        <input type="number" name="weight" step="0.01" required>
    </label>



    <label>
        Site
        <select name="site" required>
            <option value="">Select a site</option>
            {% for site_id, site_name in sites %}
                <option value="{{ site_id }}">{{ site_name }}</option>
            {% endfor %}
        </select>
    </label>

    <button type="submit">Log artefact</button>
</form>

{% if capture_mode %}
    <hr>
    <h3>Measured weight</h3>
    {% if measured_weight is not none %}
        <p><strong>{{ measured_weight }} kg</strong></p>
    {% else %}
        <p><em>No measured weight available. Using provided weight: {{ form_weight or 'N/A' }}</em></p>
    {% endif %}

    <hr>
    <h2>Live Preview</h2>
    <img id="videoStream" src="{{ url_for('artefact_video') }}" width="640"><br>
    <button type="button" onclick="startCapture()">Start Capture</button>

    <h3>Progress</h3>
    <ul id="progressLog"></ul>

    <h3>Gallery</h3>
    <div id="gallery" style="display:flex;flex-wrap:wrap;gap:8px"></div>

    <button id="saveBtn" type="button" disabled style="margin-top:12px;">Save & Continue</button>
{% endif %}

</div>
{% endif %}

<!-- JS-heavy, CSS-light -->
<script>
(() => {
    const form = document.getElementById("artefactForm");
    if (!form) return;

    // reveal form only when JS loads
    form.style.display = "block";

    // No client-side weight validation; the server measures weight automatically on submit
    form.addEventListener("submit", e => {
        // server will perform measurement; nothing to validate client-side here
    });
})();

function startCapture() {
    const artefactName = "{{ artefact_name }}";
    const btn = document.querySelector('button[onclick="startCapture()"]');
    if (!btn) return;
    if (btn.disabled) return; // already capturing

    btn.disabled = true;
    btn.textContent = 'Capturing...';

    const eventSource = new EventSource("{{ url_for('capture_artefact', artefact_name=artefact_name) }}");
    const log = document.getElementById("progressLog");
    const gallery = document.getElementById("gallery");

    eventSource.onerror = function(e) {
        const li = document.createElement('li');
        li.textContent = 'Error: failed to start capture (camera unavailable or server error)';
        log.appendChild(li);
        btn.disabled = false;
        btn.textContent = 'Start Capture';
        eventSource.close();
    };

    eventSource.onmessage = async function(e) {
        let data;
        try {
            data = JSON.parse(e.data);
        } catch (err) {
            console.error('Failed to parse SSE data', err, e.data);
            return;
        }

        const li = document.createElement("li");

        if (data.status === 'started') {
            li.textContent = 'Capture started';
            log.appendChild(li);
            return;
        }

        if(data.status === 'captured') {
            li.textContent = `Captured frame ${data.frame} of ${data.total}`;
        } else if(data.status === 'error') {
            if (data.message) {
                li.textContent = `Error: ${data.message}`;
            } else {
                li.textContent = `Error capturing frame ${data.frame}`;
            }
        } else if(data.status === 'done') {
            li.textContent = `Capture finished. ${data.captured} frames saved. Errors: ${data.errors.length}`;
            btn.disabled = false;
            btn.textContent = 'Start Capture';
            eventSource.close();

            // load gallery
            try {
                const res = await fetch("{{ url_for('photos_list', artefact_name=artefact_name) }}");
                const files = await res.json();
                gallery.innerHTML = '';
                files.forEach(f => {
                    const img = document.createElement('img');
                    img.src = `/photos/${artefactName}/${f}`;
                    img.style.width = '200px';
                    img.style.margin = '6px';
                    gallery.appendChild(img);
                });

                // enable save button now that gallery is loaded
                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save & Continue';
                    saveBtn.onclick = async function() {
                        saveBtn.disabled = true;
                        saveBtn.textContent = 'Saving...';
                        try {
                            const res = await fetch("{{ url_for('save_artefact') }}", {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ artefact_name: artefactName })
                            });
                            const data = await res.json();
                            if (res.ok && data.ok) {
                                // redirect to a fresh page
                                window.location = data.redirect || "{{ url_for('log_artefact') }}";
                            } else {
                                alert('Save failed: ' + (data.error || 'unknown'));
                                saveBtn.disabled = false;
                                saveBtn.textContent = 'Save & Continue';
                            }
                        } catch (err) {
                            console.error('Save request failed', err);
                            alert('Save request failed');
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Save & Continue';
                        }
                    }
                }

            } catch (err) {
                console.error('Failed to fetch photos', err);
            }
        }
        log.appendChild(li);
    }
}
</script>

</body>
</html>
