<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI / Upload Dashboard</title>
<style>
    body {
        font-family: system-ui, sans-serif;
        background-color: #0f172a;
        color: white;
        margin: 0;
        padding: 20px;
    }
    h1, h2 {
        margin-bottom: 10px;
    }
    button {
        margin: 5px;
        padding: 10px 20px;
        background-color: #1e293b;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }
    button:hover {
        background-color: #334155;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    th, td {
        border: 1px solid #334155;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #1e293b;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
</style>
</head>
<body>
<h1>Dashboard</h1>

<!-- Server Status -->
<h2>Server Status</h2>
<div id="server-status">Checking...</div>

<!-- Upload Queue -->
<h2>Upload Queue</h2>
<button onclick="uploadQueue()">Upload All Folders</button>
<table id="queue-table">
    <thead>
        <tr>
            <th>ID / Folder</th>
            <th>Name</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="3">Loading queue...</td></tr>
    </tbody>
</table>

<!-- Completed Uploads -->
<h2>Completed Uploads</h2>
<table id="completed-table">
    <thead>
        <tr>
            <th>ID / Folder</th>
            <th>Name</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="2">No uploads yet.</td></tr>
    </tbody>
</table>

<!-- Downloads -->
<h2>Ready Downloads</h2>
<input type="number" id="artefact-id" placeholder="Artefact ID">
<button onclick="checkDownload()">Check & Download</button>
<table id="download-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Path</th>
        </tr>
    </thead>
    <tbody>
        <tr><td colspan="3">No downloads yet.</td></tr>
    </tbody>
</table>

<script>
/* ---------------------- Server Status ---------------------- */
async function checkServer() {
    const div = document.getElementById('server-status');
    try {
        const resp = await fetch('/connect');
        const data = await resp.json();
        if (data.status === 200) {
            div.textContent = 'ONLINE';
            div.className = 'success';
        } else {
            div.textContent = 'OFFLINE';
            div.className = 'error';
        }
    } catch (err) {
        div.textContent = 'OFFLINE';
        div.className = 'error';
    }
}
checkServer();
setInterval(checkServer, 2000);

/* ---------------------- Load Queue ---------------------- */
async function loadQueue() {
    try {
        const resp = await fetch('/get_queue');
        const data = await resp.json();
        const tbody = document.querySelector('#queue-table tbody');
        tbody.innerHTML = '';
        if (!data.queue || data.queue.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">Queue is empty</td></tr>';
            return;
        }
        data.queue.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.id}</td>
                <td>${item.name}</td>
                <td id="status-${item.id}">${item.status || 'Pending'}</td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error('Error loading queue:', err);
    }
}
loadQueue();
setInterval(loadQueue, 5000);

/* ---------------------- Upload Queue ---------------------- */
async function uploadQueue() {
    const btn = document.querySelector('button[onclick="uploadQueue()"]');
    btn.disabled = true;
    btn.textContent = 'Uploading...';

    try {
        const resp = await fetch('/upload_queue', { method: 'POST' });
        const data = await resp.json();

        // Update failed/pending queue table
        const tbodyQueue = document.querySelector('#queue-table tbody');
        tbodyQueue.innerHTML = '';
        if (data.failed.length === 0) {
            tbodyQueue.innerHTML = '<tr><td colspan="3">All uploads completed</td></tr>';
        } else {
            data.failed.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.id}</td><td>${item.name}</td><td class="error">Failed</td>`;
                tbodyQueue.appendChild(tr);
            });
        }

        // Update completed uploads table
        const tbodyCompleted = document.querySelector('#completed-table tbody');
        tbodyCompleted.innerHTML = '';
        if (data.completed.length === 0) {
            tbodyCompleted.innerHTML = '<tr><td colspan="2">No uploads yet.</td></tr>';
        } else {
            data.completed.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.id}</td><td>${item.name}</td>`;
                tbodyCompleted.appendChild(tr);
            });
        }

    } catch (err) {
        console.error('Error uploading queue:', err);
        alert('Failed to upload queue.');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Upload All Folders';
    }
}

/* ---------------------- Check & Download Artefact ---------------------- */
async function checkDownload() {
    const artefactId = document.getElementById('artefact-id').value;
    if (!artefactId) return alert('Enter an artefact ID');

    try {
        const resp = await fetch('/check', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ number: artefactId })
        });
        const data = await resp.json();

        const tbody = document.querySelector('#download-table tbody');
        tbody.innerHTML = '';

        for (const id in data) {
            const item = data[id];
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${id}</td>
                <td>${item.name}</td>
                <td>${item.path}</td>
            `;
            tbody.appendChild(tr);
        }

    } catch (err) {
        console.error('Error checking download:', err);
        alert('Failed to check download. See console.');
    }
}
</script>
</body>
</html>
