<!DOCTYPE html>
<html>
<head>
    <title>Log Artefact</title>
</head>
<body>
    <h1>Log Artefact</h1>

    {% if no_sites %}
        <p>You are not a member of any site.</p>
    {% else %}
    <form method="POST" action="{{ url_for('log_artefact') }}">
        <label>Name: <input type="text" name="name" required></label><br>
        <label>Weight: <input type="number" step="0.01" name="weight" required></label><br>
        <label>Site:
            <select name="site">
                {% for id, name in sites %}
                    <option value="{{ id }}">{{ name }}</option>
                {% endfor %}
            </select>
        </label><br>
        <button type="submit">Log Artefact</button>
    </form>
    {% endif %}

    {% if capture_mode %}
        <h2>Live Preview</h2>
        <img id="videoStream" src="{{ url_for('artefact_video') }}" width="640"><br>
        <button onclick="startCapture()">Start Capture</button>

        <h3>Progress</h3>
        <ul id="progressLog"></ul>

        <script>
            function startCapture() {
                const eventSource = new EventSource("{{ url_for('capture_artefact', artefact_name=artefact_name) }}");
                const log = document.getElementById("progressLog");

                eventSource.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    const li = document.createElement("li");

                    if(data.status === 'captured') {
                        li.textContent = `Captured frame ${data.frame} of ${data.total}`;
                    } else if(data.status === 'error') {
                        li.textContent = `Error capturing frame ${data.frame}`;
                    } else if(data.status === 'done') {
                        li.textContent = `Capture finished. ${data.captured} frames saved. Errors: ${data.errors.length}`;
                        eventSource.close();
                    }
                    log.appendChild(li);
                }
            }
        </script>
    {% endif %}
</body>
</html>
